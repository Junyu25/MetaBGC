---
title: "full-siderophore-analysis"
author: "Francine Camacho"
date: "7/26/2019"
output:
  html_document: 
    smart: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/revision-synthetic-genomes/other-BGCs-poc/siderophores/HMM-analysis')
```


```{r, message = FALSE }
#load libraries
require(tidyverse)
```

### Load full profiled cyclase siderophore HMMs for synthetic genomes
```{r, message = FALSE}
#load siderophore HMM data and recode sampleType for the complexity of the synthetic sample (#of genomes in samples)
siderophore <- read_delim("combined-Siderophores-full-synthetic_genomes-results.txt",col_names = F, delim = "\t") 
names(siderophore) <- c("readID", "sampleType", "sampleID", "cyclaseType", "HMMScore")
```

##### Remove the reading frame information from the readID. 
```{r,message=FALSE}
# Function to aggregate identitical sample reads located at different reading frames 
# and take the frame with the highest HMM score
formatHMM<-function(hmmdf){
  hmmdfRecoded <- separate(hmmdf, readID, into = c("readIDOnly","F_R_read_frame"), sep = "/", extra = "merge")
  hmmdfRecoded_FR <- separate(hmmdfRecoded, F_R_read_frame, into = c("F_R","frameNumb"), sep = "_", extra = "merge")
  hmmdfRecodedDF<- within(hmmdfRecoded_FR, readID <- paste(readIDOnly,F_R, sep='/'))
  hmmdfRecodedDFUnique<-aggregate(HMMScore ~ readID + sampleID + sampleType + cyclaseType , hmmdfRecodedDF, max)
  colnames(hmmdfRecodedDFUnique)<-c("readID","Sample", "sampleType", "cyclaseType","HMMScore")
  return(hmmdfRecodedDFUnique)
}

#Keep duplicated reads if they are in different reads
siderophore_recoded<-formatHMM(siderophore) %>% filter(!str_detect("LGKI01000307.1",readID))
```

##### Load the BLAST data for Siderophore genes against our synthetic dataset. 
```{r, message=FALSE}
# BLAST unfiltered reads at 95% pident no readCoverage filter
all_sidBlastDF <- read_delim("../Siderophores-TP-reads/sidBlastDF_filter-results.txt", col_names = T, delim = "\t") %>% filter(!str_detect("LGKI01000307.1",sseqid))
all_sidBlastDF$cyclase_type <-"siderophore"

```

##### Determine manual cutoffs for each interval within the model
```{r, message=FALSE}
compareCyclaseReads<-function(cyclaseDF, blastDF){
  
  names(blastDF)[names(blastDF)=="sseqid"] <-"readID"
  names(blastDF)[names(blastDF)=="qseqid"] <-"bgcName"
  names(cyclaseDF)[names(cyclaseDF)=="cyclaseType"] <-"cyclase_type"
  
  common_reads <- blastDF %>% inner_join(.,cyclaseDF) %>% select(-c(HMMScore))
  common_reads$readCheck<-"common-read"
  
  hmm_unique_reads <- cyclaseDF %>% anti_join(.,blastDF)
  blast_unique_reads <- blastDF %>% anti_join(.,cyclaseDF)
  blast_unique_reads$readCheck<-"blast-unique-read"
  if (nrow(hmm_unique_reads) >0){
    hmm_unique_reads$readCheck<-"hmm-unique-read"
    blast_common_data <- rbind(common_reads, blast_unique_reads)
    allCyclases_TP<- blast_common_data %>% full_join(.,hmm_unique_reads) 
    allCyclases_TP$bgcName[is.na(allCyclases_TP$bgcName)]<-"hmm-unique-read"
    return(allCyclases_TP %>% select(-c(HMMScore)))
    
  }else{
    blast_common_data <- rbind(common_reads, blast_unique_reads)
    return(blast_common_data)
  }

  
}
##############################################################################################
sid_bin <- compareCyclaseReads(siderophore_recoded,all_sidBlastDF)
names(sid_bin)[names(sid_bin)=="cyclase_type"] <-"cyclaseType"
```

##### Trying to determine the HMM cutoffs; calculate median 

```{r, message=FALSE}

compare_reads <- function(hmm_df, blast_df){
  names(blast_df)[names(blast_df)=="sseqid"] <-"readID"
  names(blast_df)[names(blast_df)=="qseqid"] <-"bgcName"
  names(hmm_df)[names(hmm_df)=="cyclaseType"] <-"cyclase_type"
  
  common_reads <- hmm_df %>% semi_join(.,blast_df) 
  common_reads$readCheck<-"common-read"
  hmm_unique_reads <- hmm_df %>% anti_join(.,blast_df)
  hmm_unique_reads$readCheck<-"hmm-unique-read"
  compared_data <- rbind(common_reads, hmm_unique_reads)
  return(compared_data)
}

compare_reads(siderophore_recoded, all_sidBlastDF) %>% filter(readCheck == "common-read") %>% mutate(medianScore = round(median(HMMScore))) %>% distinct(readCheck, medianScore) %>% ungroup()

```

### Apply different HMM Scores cutoff to the HMM dataset
```{r,message=FALSE}
#Filter siderophore data with cutoffs to compare to BLAST interval reads 
sid_filtered_median <- siderophore_recoded %>% filter(HMMScore >=30) %>% inner_join(.,sid_bin)

#sid_filtered_median  %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)

pks_genomes_median_check <-c("CP012944.1", "gi|928416322|gb|LGKI01000367.1|", "CP014065.1", "gi|529222834|ref|NC_021985.1|",
                             "gi|1081599680|emb|FMWJ01000019.1|", "AZXI01000015.1", "JOFH01000011.1")

remaining_hmm_sid_pos_median_check <- sid_filtered_median %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% filter(scaffold_id %in% pks_genomes_median_check)

####################################################################################
sid_filtered_median_subfive<- siderophore_recoded %>% filter(HMMScore >=25) %>% inner_join(.,sid_bin)

#sid_filtered_median_subfive  %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)

pks_genomes_subfive_check <-c("AZXI01000015.1", "CP011998.1", "CP012944.1", "CP014065.1", "gi|1081599680|emb|FMWJ01000019.1|",
                              "gi|928416322|gb|LGKI01000367.1|", "CP016022.1", "gi|529222834|ref|NC_021985.1|", 
                              "HE965803.1", "gi|640935821|gb|JJOH01000007.1|", "DQ381420.1", "JOFH01000020.1",
                              "JOFH01000009.1", "JOFH01000011.1")


remaining_hmm_sid_pos_subfive_check <- sid_filtered_median_subfive %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% filter(scaffold_id %in% pks_genomes_subfive_check)
####################################################################################                                 
sid_filtered_median_plusfive <- siderophore_recoded %>% filter(HMMScore>=35) %>% inner_join(.,sid_bin)

#sid_filtered_median_plusfive  %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% distinct(scaffold_id)
pks_genomes_plusfive_check <- c("CP012944.1")
remaining_hmm_sid_pos_plusfive_check <- sid_filtered_median_plusfive %>% filter(readCheck == "hmm-unique-read") %>% separate(readID, c("scaffold_id", "rest_id"), sep = "-", remove = F) %>% filter(scaffold_id %in% pks_genomes_plusfive_check)

```


```{r}
#Function to parse out HMM unique reads for each sample. 
parseReads <- function(HMMdf, modelName, dirname){
  setwd(dirname)
  samples<-unique(HMMdf$Sample)
  for (s in 1:length(samples)){
    currentSample<-samples[s]
    currentSampleResults<- HMMdf %>% filter(Sample == currentSample)
    currentSampleReads<- unique(currentSampleResults$readID)
    fileName<-paste0(currentSample,paste("-",modelName,"-hmm_unique",sep =""), ".txt", sep ="")
    write.table(currentSampleReads,fileName, quote = F, row.names = F, col.names = F )
  }
}

#parseReads(remaining_hmm_sid_pos_median_check, "siderophore", "/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/revision-synthetic-genomes/other-BGCs-poc/siderophores/HMM-analysis/full_model-analysis/hmm-unique-analysis/median_score/")

#parseReads(remaining_hmm_sid_pos_subfive_check, "siderophore", "/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/revision-synthetic-genomes/other-BGCs-poc/siderophores/HMM-analysis/full_model-analysis/hmm-unique-analysis/minus_five_score")

#parseReads(remaining_hmm_sid_pos_plusfive_check, "siderophore", "/Users/francinecamacho/Google Drive/T2PKS-paper/computational_analysis/synthetic_genomes/revision-synthetic-genomes/other-BGCs-poc/siderophores/HMM-analysis/full_model-analysis/hmm-unique-analysis/plus_five_score/")

```

```{r, message=FALSE}
#Load hmm-unique blast to sid domains reads to remove them from the F1 analysis 
sid_hmmunique_blast <- read_tsv("full_model-analysis/hmm-unique-analysis/sid_hmm-unique_blast-results.txt", col_names = T)

calculate_F1 <- function(df){
  TP <- df %>% filter(readCheck == "common-read") %>% nrow()
  FP <- df %>% filter(readCheck == "hmm-unique-read") %>% nrow()
  FN <- df %>% filter(readCheck == "blast-unique-read") %>% nrow()
  F1_metric <- (2*TP)/((2*TP)+FP+FN)
  print(F1_metric)
  return(F1_metric)
  
  
}

remove_sid_reads_subfive <- sid_hmmunique_blast %>% filter(cutoff == "minus_five_score") %>% select(qseqid, Sample) %>% distinct()
names(remove_sid_reads_subfive)[1] <- "readID"

remove_sid_reads_median <- sid_hmmunique_blast %>% filter(cutoff == "median_score") %>% select(qseqid, Sample) %>% distinct()
names(remove_sid_reads_median)[1] <- "readID"
remove_sid_reads_plusfive <- sid_hmmunique_blast %>% filter(cutoff == "plus_five_score") %>% select(qseqid, Sample) %>% distinct()
names(remove_sid_reads_plusfive)[1] <- "readID"

sid_f1_cutoff_median <-  calculate_F1(compareCyclaseReads(siderophore_recoded %>% anti_join(., remove_sid_reads_median) %>% filter(HMMScore >=30),all_sidBlastDF)) #0.1109256
sid_f1_cutoff_plusfive <- calculate_F1(compareCyclaseReads(siderophore_recoded %>% anti_join(., remove_sid_reads_plusfive) %>% filter(HMMScore >=35),all_sidBlastDF)) #0.03321645
sid_f1_cutoff_subfive <- calculate_F1(compareCyclaseReads(siderophore_recoded %>% anti_join(., remove_sid_reads_subfive) %>% filter(HMMScore >=25),all_sidBlastDF)) #0.2151334
```

```{r}
sessionInfo()
```


